# Program Remote Procedure Call (RPC) untuk Transfer File

| Nama | NRP |
| -------------------------------------- | ---------- |
| Steven Figo | 5027221021 |
| Samuel Yuma Krismata | 5027221029 |
| Gavriel Pramuda Kurniaadi | 5027221031 |

## Dokumentasi Program
[Dokumentasi Program RPC](https://drive.google.com/file/d/1eYCjgshnGRc_GnLhrrb-TueJJ6eIr5ZG/view?usp=share_link)

- [up_down.x](#up_downx) 
- [Makefile.up_down](#makefileup_down)
- [up_down_server.c](#up_down_serverc)
  - [Fungsi ud_1_svc](#fungsi-ud_1_svc)
  - [Bagian Upload](#bagian-upload)
  - [Bagian Download](#bagian-download)
  - [Bagian List File](#bagian-list-file)
- [up_down_client.c](#up_down_clientc)
  - [Bagian Get_file_name_from_path](#bagian-get_file_name_from_path)
  - [Bagian updown_1](#bagian-updown_1)
  - [Bagian main](#bagian-main)

## up_down.x
```up_down.x
struct chunk{
    char sendBuff[1025];
    char dirname[1000];
    int flag;
};

program UPDOWN {
    version UPDOWN_1 {
        struct chunk UD(chunk) = 1;
    } = 1;
} = 0x2fffffff;
```
Deklarasi struct chunk dengan anggota:
- Variabel sendBuff yang berfungsi untuk menyimpan data yang akan dikirim atau diterima oleh RPC
- Variabel dirname berfungsi untuk menyimpan nama direktori atau path file terkait dengan operasi yang dilakukan oleh program
- Variabel flag berfungsi sebagai indikator atau kontrol flag untuk mengontrol alur eksekusi program
Fungsi program UPDOWN merupakan fungsi yang menjadi kerangka kerja untuk berkomunikasi antara program yang menggunakan protokol RPC dengan prosedur yang meliputi: 
- Mengelompokkan seluruh definisi pada program UPDOWN yang merupakan unit dasar
- Mendefinisikan versi pertama dari program UPDOWN dengan nama UPDOWN_1
- Mendefinisikan prosedur UD dalam versi UPDOWN_1 yang melibatkan struktur parameter dan nilai return
- Menetapkan nomor versi UPDOWN_1 sebagai 1 dan nomor identifikasi program UPDOWN sebagai 0x2fffffff

## Makefile.up_down
``` Makefile.up_down
# This is a template Makefile generated by rpcgen

# Parameters

CLIENT = up_down_client
SERVER = up_down_server

SOURCES_CLNT.c = 
SOURCES_CLNT.h = 
SOURCES_SVC.c = 
SOURCES_SVC.h = 
SOURCES.x = up_down.x

TARGETS_SVC.c = up_down_svc.c up_down_server.c up_down_xdr.c 
TARGETS_CLNT.c = up_down_clnt.c up_down_client.c up_down_xdr.c 
TARGETS = up_down.h up_down_xdr.c up_down_clnt.c up_down_svc.c up_down_client.c up_down_server.c

OBJECTS_CLNT = $(SOURCES_CLNT.c:%.c=%.o) $(TARGETS_CLNT.c:%.c=%.o)
OBJECTS_SVC = $(SOURCES_SVC.c:%.c=%.o) $(TARGETS_SVC.c:%.c=%.o)
# Compiler flags 

CFLAGS += -I/usr/include/tirpc -g
LDLIBS += -lnsl -ltirpc
RPCGENFLAGS = 

# Targets 

all : $(CLIENT) $(SERVER)

$(TARGETS) : $(SOURCES.x) 
	rpcgen $(RPCGENFLAGS) $(SOURCES.x)

$(OBJECTS_CLNT) : $(SOURCES_CLNT.c) $(SOURCES_CLNT.h) $(TARGETS_CLNT.c) 

$(OBJECTS_SVC) : $(SOURCES_SVC.c) $(SOURCES_SVC.h) $(TARGETS_SVC.c) 

$(CLIENT) : $(OBJECTS_CLNT) 
	$(LINK.c) -o $(CLIENT) $(OBJECTS_CLNT) $(LDLIBS) 

$(SERVER) : $(OBJECTS_SVC) 
	$(LINK.c) -o $(SERVER) $(OBJECTS_SVC) $(LDLIBS)

 clean:
	 $(RM) core $(TARGETS) $(OBJECTS_CLNT) $(OBJECTS_SVC) $(CLIENT) $(SERVER)
```
- Bagian Parameters
  - CLIENT dan SERVER merupakan nama target untuk file biner yang akan dihasilkan, yaitu client dan server
  - SOURCES_CLNT.c, SOURCES_CLNT.h, SOURCES_SVC.c, SOURCES_SVC.h merupakan daftar file awal dan header untuk client dan server, yaitu client_clnt.c, server_clnt.h, dan seterusnya
  - SOURCES.x merupakan file definisi RPC, yaitu up_down.x
- Bagian TARGETS and OBJECTS
  - TARGETS merupakan daftar file target yang akan dihasilkan dari rpcgen
  - OBJECTS_CLNT dan OBJECTS_SVC merupakan daftar objek yang akan dihasilkan dari file awal client dan server
- Bagian Compiler Flags
  - CFLAGS merupakan variabel untuk menambahkan opsi compile yang mana dalam hal ini untuk menyertakan direktori header dan mode debug
  - LDLIBS merupakan variabel untuk menyertakan library yang diperlukan, yaitu libnsl dan libtirpc
- Bagian Targets
  - all merupakan target utama untuk membuat client dan server
  - $(TARGETS) merupakan argument untuk membuat file target dari definisi RPC menggunakan rpcgen
  - $(OBJECTS_CLNT) dan $(OBJECTS_SVC) merupakan argumen untuk membuat objek dari file awal client dan server
  - $(CLIENT) dan $(SERVER) merupakan argumen untuk membuat file biner untuk client dan server
- Bagian Clean Target
  - clean merupakan argumen untuk menghapus file yang dihasilkan selama proses compile


## up_down_server.c
``` up_down_server.c
#include <sys/types.h>
#include <dirent.h>
#include "up_down.h"

struct chunk *ud_1_svc(chunk *argp, struct svc_req *rqstp) {
  static struct chunk result;

  if (argp->flag == 1) {
    // Get the data, dump it to a file
    FILE *fp;
    char *filename = argp->dirname;
    char prefix[10] = "uploaded_";
    strcat(prefix, filename);
    fp = fopen(prefix, "ab+");
    
    if (fp == NULL) {
      printf("Sorry, the file cannot be opened");
      exit(1);
    }
    
    fwrite(argp->sendBuff, 1, strlen(argp->sendBuff), fp);
    fclose(fp);
  } else if (argp->flag == 2) {
    // Get a request to send the file
    FILE *fp;
    fp = fopen(argp->dirname, "rb+");
    
    if (fp == NULL) {
      printf("Sorry, the file cannot be opened");
      exit(1);
    }
    
    memset(argp->sendBuff, 0, sizeof(argp->sendBuff));
    int nread = fread(argp->sendBuff, 1, 2049, fp);
    result = *argp;

    if (nread > 0 && nread == 2049) {
      // If you read successfully, then send this data
      return &result;
    } else if (ferror(fp)) {
      printf("Error reading\n");
    } else {
      result.flag = 4;
      return &result;
    }
    
    fclose(fp);
} else {
    DIR *dp;
    struct dirent *ep;
    dp = opendir("./");

    if (dp != NULL) {
      while (ep = readdir(dp)) {
        char fname[50];
        memset(fname, 0, sizeof(fname));
        strcpy(fname, ep->d_name);
        strcat(fname, "--");
        strcat(result.dirname, fname);
      }
    } else {
      perror("Couldn't open the directory");
    }
  }
  return &result;
}
```

### Fungsi ud_1_svc
```c
struct chunk *ud_1_svc(chunk *argp, struct svc_req *rqstp) {
  static struct chunk result;
```

Fungsi ini adalah bagian dari program yang berfungsi sebagai server untuk menerima permintaan dari klien dan memberikan respon berdasarkan permintaan tersebut. Fungsi ini menerima argumen argp, yang merupakan struktur chunk yang berisi data yang akan diunggah atau diunduh, serta struktur svc_req yang berisi informasi tentang permintaan dari klien

### Bagian Upload
Bagian ini menangani operasi upload data ke server
```c
  if (argp->flag == 1) {
    // Mendapatkan data dan menyalinnya ke file
    FILE *fp;
    char *filename = argp->dirname;
    char prefix[10] = "uploaded_";
    strcat(prefix, filename);
    fp = fopen(prefix, "ab+");

    if (fp == NULL) {
      printf("Sorry, the file cannot be opened");
      exit(1);
    }

    fwrite(argp->sendBuff, 1, strlen(argp->sendBuff), fp);
    fclose(fp);
  }
```

- ‘argp->flag == 1’ digunakan untuk memeriksa apakah klien mengirimkan data untuk diunggah
- Kode membuka file dengan nama "uploaded_" + nama file yang dikirim oleh klien, dan mode "ab+" yang berarti membuka file dalam mode append dan read/write
- Data yang dikirim oleh klien disimpan ke dalam file tersebut
- Jika file tidak dapat dibuka, program mencetak pesan kesalahan dan keluar dari program

### Bagian Download
```c
 else if (argp->flag == 2) {
    // Mendapatkan permintaan untuk mengirimkan file
    FILE *fp;
    fp = fopen(argp->dirname, "rb+");

    if (fp == NULL) {
      printf("Sorry, the file cannot be opened");
      exit(1);
    }

    memset(argp->sendBuff, 0, sizeof(argp->sendBuff));
    int nread = fread(argp->sendBuff, 1, 2049, fp);
    result = *argp;

    if (nread > 0 && nread == 2049) {
      // Jika berhasil dibaca, kirim data ini
      return &result;
    } else if (ferror(fp)) {
      printf("Error reading\n");
    } else {
      result.flag = 4;
      return &result;
    }

    fclose(fp);
  }
```
- ‘argp->flag == 2’ digunakan untuk memeriksa apakah klien meminta untuk mengunduh data
- Kode membuka file dengan nama yang diberikan oleh klien dalam mode "rb+" yang berarti membuka file dalam mode read/write
- Data dari file dibaca ke dalam ‘argp->sendBuff’
- Jika data berhasil dibaca dan memiliki ukuran 2049 byte, maka data ini akan dikirim sebagai respons
- Jika ada kesalahan saat membaca file, pesan kesalahan akan dicetak
- Jika file tidak dapat dibuka atau data tidak dapat dibaca, respons akan mengandung flag 4

### Bagian List File
```c
 else {
    DIR *dp;
    struct dirent *ep;
    dp = opendir("./");

    if (dp != NULL) {
      while (ep = readdir(dp)) {
        char fname[50];
        memset(fname, 0, sizeof(fname));
        strcpy(fname, ep->d_name);
        strcat(fname, "--");
        strcat(result.dirname, fname);
      }
    } else {
      perror("Couldn't open the directory");
    }
  }
  return &result;
}
```

- Jika ‘argp->flag’ bukan 1 atau 2, maka server akan mencoba untuk mengembalikan daftar file dalam direktori saat ini
- Server membuka direktori saat ini menggunakan opendir("./")
- Jika direktori berhasil dibuka, server akan membaca nama-nama file dalam direktori dan menggabungkannya ke dalam result.dirname
- Jika ada kesalahan saat membuka direktori, pesan kesalahan akan dicetak

Fungsi ini mengembalikan result, yang akan berisi data yang akan dikirim sebagai respons kepada klien

### Screenshot Output
- Menjalankan server

![image](https://github.com/GavrielAdi/rpc-programming/assets/110652010/d14550f0-14ca-43bc-9503-6aa7e98f8c95)

## up_down_client.c
```c
#include "up_down.h"

char *get_file_name_from_path(char *filepath, char *delimiter) {
  char *token = strtok(filepath, delimiter);
  char *actual_file = NULL;
  while (token != NULL) {
    actual_file = token;
    token = strtok(NULL, delimiter);
  }
  return actual_file;
}

void updown_1(char *host, char *command, char *filepath) {
  CLIENT *clnt;
  struct chunk *result_1;
  chunk ud_1_arg;

#ifndef DEBUG
  clnt = clnt_create(host, UPDOWN, UPDOWN_1, "udp");
  if (clnt == NULL) {
    clnt_pcreateerror(host);
    exit(1);
  }
#endif /* DEBUG */

  FILE *fp;

  if (strcmp(command, "-upload") == 0) {
    ud_1_arg.flag = 1;
    fp = fopen(filepath, "rb");
    if (fp == NULL) {
      printf("Sorry the file cannot be opened");
      exit(1);
    }
    char *actual_file = get_file_name_from_path(filepath, "/");
    strcpy(ud_1_arg.dirname, actual_file);
    while (1) {
      memset(ud_1_arg.sendBuff, 0, sizeof(ud_1_arg.sendBuff));
      int nread = fread(ud_1_arg.sendBuff, 1, 2049, fp);
      if (nread > 0) {
        result_1 = ud_1(&ud_1_arg, clnt);
      }
      if (nread < 2049) {
        if (ferror(fp)) printf("Error reading\n");
        break;
      }
    }
    fclose(fp);
  } else if (strcmp(command, "-download") == 0) {
    ud_1_arg.flag = 2;
    strcpy(ud_1_arg.dirname, filepath);
    char *actual_file = get_file_name_from_path(filepath, "/");
    fp = fopen(actual_file, "ab+");
    if (fp == NULL) {
      printf("Sorry the file cannot be opened");
      exit(1);
    }
    do {
      result_1 = ud_1(&ud_1_arg, clnt);
      fwrite(result_1->sendBuff, 1, strlen(result_1->sendBuff), fp);
    } while (result_1->flag != 4);
    fclose(fp);
  } else if (strcmp(command, "-getdir") == 0) {
    result_1 = ud_1(&ud_1_arg, clnt);
    char *token = strtok(result_1->dirname, "--");
    while (token != NULL) {
      printf(" %s\n", token);
      token = strtok(NULL, "--");
    }
  } else {
    printf("Enter a valid command !!!");
  }

  if (result_1 == (struct chunk *)NULL) {
    clnt_perror(clnt, "call failed");
  }

#ifndef DEBUG
  clnt_destroy(clnt);
#endif /* DEBUG */
}

int main(int argc, char *argv[]) {
  char *host, *command, *path = NULL;

  if (argc < 3) {
    printf("Usage: %s server_host -getdir\n%s server_host -upload | -download path_of_the_file\n", argv[0], argv[0]);
    exit(1);
  }

  host = argv[1];
  command = argv[2];

  if (argc > 3) path = argv[3];

  updown_1(host, command, path);
  exit(0);
}
```

### Bagian Get_file_name_from_path
```c
char *get_file_name_from_path(char *filepath, char *delimiter) {
  char *token = strtok(filepath, delimiter);
  char *actual_file = NULL;
  while (token != NULL) {
    actual_file = token;
    token = strtok(NULL, delimiter);
  }
  return actual_file;
}
```

Ini adalah fungsi bantuan yang digunakan untuk mendapatkan nama file aktual dari jalur (path) yang mungkin mengandung karakter pembatas (delimiter) seperti "/". Fungsi ini mengembalikan nama file dari path yang diberikan
### Bagian updown_1
```c
void updown_1(char *host, char *command, char *filepath) {
  CLIENT *clnt;
  struct chunk *result_1;
  chunk ud_1_arg;

#ifndef DEBUG
  clnt = clnt_create(host, UPDOWN, UPDOWN_1, "udp");
  if (clnt == NULL) {
    clnt_pcreateerror(host);
    exit(1);
  }
#endif /* DEBUG */

  FILE *fp;

  if (strcmp(command, "-upload") == 0) {
    ud_1_arg.flag = 1;
    fp = fopen(filepath, "rb");
    if (fp == NULL) {
      printf("Sorry the file cannot be opened");
      exit(1);
    }
    char *actual_file = get_file_name_from_path(filepath, "/");
    strcpy(ud_1_arg.dirname, actual_file);
    while (1) {
      memset(ud_1_arg.sendBuff, 0, sizeof(ud_1_arg.sendBuff));
      int nread = fread(ud_1_arg.sendBuff, 1, 2049, fp);
      if (nread > 0) {
        result_1 = ud_1(&ud_1_arg, clnt);
      }
      if (nread < 2049) {
        if (ferror(fp)) printf("Error reading\n");
        break;
      }
    }
    fclose(fp);
  } else if (strcmp(command, "-download") == 0) {
    ud_1_arg.flag = 2;
    strcpy(ud_1_arg.dirname, filepath);
    char *actual_file = get_file_name_from_path(filepath, "/");
    fp = fopen(actual_file, "ab+");
    if (fp == NULL) {
      printf("Sorry the file cannot be opened");
      exit(1);
    }
    do {
      result_1 = ud_1(&ud_1_arg, clnt);
      fwrite(result_1->sendBuff, 1, strlen(result_1->sendBuff), fp);
    } while (result_1->flag != 4);
    fclose(fp);
  } else if (strcmp(command, "-getdir") == 0) {
    result_1 = ud_1(&ud_1_arg, clnt);
    char *token = strtok(result_1->dirname, "--");
    while (token != NULL) {
      printf(" %s\n", token);
      token = strtok(NULL, "--");
    }
  } else {
    printf("Enter a valid command !!!");
  }

  if (result_1 == (struct chunk *)NULL) {
    clnt_perror(clnt, "call failed");
  }

#ifndef DEBUG
  clnt_destroy(clnt);
#endif /* DEBUG */
}
```

- ‘host’: Merupakan alamat server yang akan dihubungi
- ‘command’: Merupakan perintah yang akan dijalankan, yang bisa berupa "-upload" untuk mengunggah file, "-download" untuk mengunduh file, atau "-getdir" untuk mendapatkan daftar file dalam direktori server
- ‘filepath’: Merupakan jalur (path) ke file yang akan diunggah atau diunduh. Jalur ini bisa berisi nama file atau direktori yang akan diakses

Dalam fungsi ini, client melakukan langkah-langkah berikut:
- Membuka koneksi dengan server menggunakan clnt_create untuk membuat objek CLIENT
- Memeriksa apakah perintah yang diberikan adalah "-upload", "-download", atau "-getdir"
- Jika perintah adalah "-upload", maka client membaca file yang akan diunggah dan mengirimnya ke server menggunakan fungsi ud_1. Data dari file dibaca dalam potongan-potongan dengan ukuran 2049 byte dan dikirimkan ke server hingga seluruh file terunggah
- Jika perintah adalah "-download", client mengirim permintaan ke server untuk mengunduh file yang sesuai. Data yang diterima dari server ditulis ke file lokal hingga server memberikan respons dengan flag 4, menandakan bahwa semua data telah diunduh
- Jika perintah adalah "-getdir", client mengirim permintaan ke server untuk mendapatkan daftar file dalam direktori server. Data daftar file tersebut kemudian diuraikan dan ditampilkan kepada pengguna
- Jika perintah tidak valid, maka pesan kesalahan akan ditampilkan

### Bagian main
```c
int main(int argc, char *argv[]) {
  char *host, *command, *path = NULL;

  if (argc < 3) {
    printf("Usage: %s server_host -getdir\n%s server_host -upload | -download path_of_the_file\n", argv[0], argv[0]);
    exit(1);
  }

  host = argv[1];
  command = argv[2];

  if (argc > 3) path = argv[3];

  updown_1(host, command, path);
  exit(0);
}
```
- ‘server_host’: Alamat host tempat server berjalan
- ‘command’: Perintah yang akan dijalankan oleh client (-upload, -download, atau -getdir)
- ‘path_of_the_file’: Jalur ke file yang akan diunggah atau diunduh Argumen ini hanya diperlukan jika perintah adalah -upload atau -download


### Screenshot Output
- Upload

![image](https://github.com/GavrielAdi/rpc-programming/assets/110652010/75630fbc-410d-4507-839e-0a7137d1625c)

- Download

![image](https://github.com/GavrielAdi/rpc-programming/assets/110652010/4e96c1f6-f84f-4fba-931f-24d71eb337ad)
